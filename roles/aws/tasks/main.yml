- name: Provison VPC
  local_action:
    module: ec2_vpc
    state: present
    cidr_block: 10.10.0.0/16
    resource_tags: { "Environment":"Load Test" }
    internet_gateway: True
    subnets:
      - cidr: 10.10.10.0/24
        az: "{{ aws_region }}c"
    route_tables:
      - subnets:
          - 10.10.10.0/24
        routes:
          - dest: 0.0.0.0/0
            gw: igw
    region: "{{ aws_region }}"
    wait: yes
  register: vpc

- name: Provision SG
  local_action:
    module: ec2_group
    state: present
    name: "loadtest"
    description: "allow ssh"
    vpc_id: "{{ vpc.vpc_id }}"
    region: "{{ aws_region }}"
    rules:
      - proto: tcp
        from_port: 22
        to_port: 22
        cidr_ip: 0.0.0.0/0

- name: Provision EC2 instance - controller 
  local_action:
    module: ec2
    region: "{{ aws_region }}"
    keypair: "{{ aws_keypair }}"
    group: "loadtest"
    instance_type: "{{ aws_instanceType }}"
    image: "{{ aws_image }}"
    instance_tags:
      role: openstack-controller
    exact_count: 1
    count_tag:
      role: openstack-controller
    vpc_subnet_id: "{{ vpc.subnets[0].id }}"
    assign_public_ip: True
    private_ip: 10.10.10.101
    wait: yes
  with_items:
    - instance_name: 'controller'
  register: controller

- name: Provision EC2 instance - network 
  local_action:
    module: ec2
    region: "{{ aws_region }}"
    keypair: "{{ aws_keypair }}"
    group: "loadtest"
    instance_type: "{{ aws_instanceType }}"
    image: "{{ aws_image }}"
    instance_tags:
      role: openstack-network
    exact_count: 1
    count_tag:
      role: openstack-network
    vpc_subnet_id: "{{ vpc.subnets[0].id }}"
    assign_public_ip: True
    private_ip: 10.10.10.102
    wait: yes
  with_items:
    - instance_name: 'network'
  register: network

- name: Provision EC2 instance - compute 
  local_action:
    module: ec2
    region: "{{ aws_region }}"
    keypair: "{{ aws_keypair }}"
    group: "loadtest"
    instance_type: "{{ aws_instanceType }}"
    image: "{{ aws_image }}"
    instance_tags:
      role: openstack-compute
    exact_count: 1
    count_tag:
      role: openstack-compute
    vpc_subnet_id: "{{ vpc.subnets[0].id }}"
    assign_public_ip: True
    private_ip: 10.10.10.103
    wait: yes
  with_items:
    - instance_name: 'compute'
  register: compute

- name: Provision EC2 instance - benchmark 
  local_action:
    module: ec2
    region: "{{ aws_region }}"
    keypair: "{{ aws_keypair }}"
    group: "loadtest"
    instance_type: "{{ aws_instanceType }}"
    image: "{{ aws_image }}"
    instance_tags:
      role: openstack-benchmark
    exact_count: 1
    count_tag:
      role: openstack-benchmark
    vpc_subnet_id: "{{ vpc.subnets[0].id }}"
    assign_public_ip: True
    private_ip: 10.10.10.104
    wait: yes
  with_items:
    - instance_name: 'benchmark'
  register: benchmark

- name: Add host addresses to inventory (hosts)
  template: 
    src=hosts.j2
    dest="{{ inventory_dir }}/hosts"

